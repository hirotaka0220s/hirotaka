<!DOCTYPE html>
<html>
<body>

    <!-- このdivタグの中に地図を表示 -->
    <div id="map" style="width:400px; height:300px"></div>

    <!-- このformタグでローカル上にある歩行データを取得 -->
    <form name="myform">
        <input name="myfile" type="file" />
    </form>

    <!-- ここからyahooのjavascript地図apiを扱う -->
    <script type="text/javascript" charset="utf-8" src="https://map.yahooapis.jp/js/V1/jsapi?appid=dj00aiZpPVRSdjMyWXc0VkZqUSZzPWNvbnN1bWVyc2VjcmV0Jng9NzM-"></script>
    <script type="text/javascript">

        //地図を表示する全体の関数displayMap
        function displayMap(){

            // 地図のオブジェクトを作る
            var ymap = new Y.Map("map");

            // 緯度と経度を引数にして、2点間の距離を出す関数distance
            function distance(lat1, lng1, lat2, lng2) {
                lat1 *= Math.PI / 180;
                lng1 *= Math.PI / 180;
                lat2 *= Math.PI / 180;
                lng2 *= Math.PI / 180;
                return 6371 * Math.acos(Math.cos(lat1) * Math.cos(lat2) * Math.cos(lng2 - lng1) + Math.sin(lat1) * Math.sin(lat2));
            }

            //Form要素を取得する
            var form = document.forms.myform;

            //ファイルが読み込まれた時の処理
            form.myfile.addEventListener('change', function(e) {
                var result = e.target.files[0];　　//読み込んだファイル情報を取得
                var reader = new FileReader();      //FileReaderのインスタンスを作成
                reader.readAsText(result);          //読み込んだファイルの中身を取得する
                var previousLat;　　　          
                var previousLon;               
                var latlngs = [];                   //後から線を引くために配列latlngsの定義
                reader.addEventListener('load', function(){
                    var array = reader.result.split(',');       //CSVファイルを ','で区切り配列にする
                    previousLat = array[4];                     //出発時の緯度を代入
                    previousLon = array[5];                     //出発時の経度を代入

                    //Y.MapオブジェクトのdrawMap()メソッドを使用して、初期化した地図を表示する
                    //引数は左から順に....
                    //1.中心の緯度経度 2.ズームレベル（数字大　=>　ズーム大） 3.レイヤーセットID（表示する地図の種類）を意味する
                    ymap.drawMap(new Y.LatLng(previousLat, previousLon), 18, Y.LayerSetId.NORMAL);
                    
                    //初期の緯度と経度をlatlngs配列にpush
                    latlngs.push(new Y.LatLng(previousLat, previousLon));

                    //出発以降は、直前の緯度と経度を、現在の緯度と経度と、比較して距離を出して、
                    //その距離で速度を出す。
                    //条件によって、表示する線の色や太さを変えて、地図上に歩行ルートを表す。
                    for(i=7; i<=array.length; i+=3){
                        var lat = array[i];     //現在の緯度を代入
                        var lon = array[i+1];   //現在の経度を代入
                        var spd = distance(previousLat, previousLon, lat , lon);    //distance関数で速度を出す
                        console.log('speed!!!!!!', spd);                //速度がちゃんと計算されているかconsoleで確認
                        latlngs.push(new Y.LatLng(lat, lon));           //現在の緯度と経度をlatlngs配列にpush

                        
                        switch(true){
                            //ここのcaseは、1km/hより遅い速度だと、赤色の太線で表示する
                            case spd < 1:
                                    //線のスタイルを設定するために、Y.Styleインスタンスを作成
                                    //引数は左から順に... 1.色  2.太さ（数字大　=>　太さup) 3.透明度（1が一番濃い）
                                    var style = new Y.Style("FF0000", 16, 1);
                                    //実際に線を作成するために、Y.Polylineインスタンスを作成
                                    //引数は左から順に...　1.線を作成するための点が集まった配列 2.線のスタイル
                                    var polyline = new Y.Polyline(latlngs, {strokeStyle: style});
                                    // addFeatureメソッドでマップに線を追加
                                    ymap.addFeature(polyline);
                                    //現在の緯度と経度を、以前の緯度と経度の変数に代入
                                    previousLat = lat;
                                    previousLon = lon;
                                    //switch文から出る。
                                    break;
                              //ここのcaseは、1km/h以上の速度だと、青色で、先よりは細いせんで表示する
                            　case spd >= 1:
                                　	var style = new Y.Style("0000FF", 8, 1);
                                    var polyline = new Y.Polyline(latlngs, {strokeStyle: style});
                                    ymap.addFeature(polyline);
                                    previousLat = lat;
                                    previousLon = lon;
                                    console.log('im here');
                                    break;
                        }
                        setTimeout(5000);   //これで5秒ずつ線が伸びて欲しかったが、そうできなった。
                    }
                    
                })
                })
        }
    </script>
    <script>displayMap()</script>       <!-- displayMapを実行する。 -->
</body>
</html>